---
- hosts: localhost
  remote_user: root
  vars:
    sshd_config: {}
    ssh_config: {}
  tasks:
    - name: mount kickoff floppy
      args:
        executable: /bin/bash
      shell: |
        mount /media/fd0
    - name: load kvm_machine config from floppy
      include_vars:
        file: /media/fd0/kickoff.yml
        name: kvm_machine
    - name: umount kickoff floppy
      args:
        executable: /bin/bash
      shell: |
        umount /media/fd0
    - name: make /tmp a tmpfs if it isnt one yet
      linefile:
        path: /mnt/etc/fstab
        regexp: '^tmpfs'
        line: 'tmpfs /tmp tmpfs rw,nosuid,mode=1777 0 0'
    - template:
       dest: "/etc/hostname"
       src: templates/etc-hostname.j2
       owner: root
       group: root
       mode: "0644"
    - file:
       path: "/root/.ssh"
       state: directory
       owner: root
       group: root
       mode: "0700"
    - template:
       dest: "/root/.ssh/authorized_keys"
       src: templates/root-.ssh-authorized_keys.j2
       owner: root
       group: root
       mode: "0644"
    - template:
       dest: "/etc/network/interfaces"
       src: templates/etc-network-interfaces.j2
       owner: root
       group: root
       mode: "0644"
    - template:
       dest: "/etc/acpi/events/powerbtn"
       src: templates/etc-acpi-events-powerbtn.j2
       owner: root
       group: root
       mode: "0644"
    - template:
       dest: "/etc/acpi/powerbtn.sh"
       src: templates/etc-acpi-powerbtn.sh.j2
       owner: root
       group: root
       mode: "0755"
    - name: resize_image
      args:
        executable: /bin/bash
      shell: |
        mount -o remount,ro / || exit $?
        /usr/local/bin/fdisk_max_partition.sh /dev/sda || exit $?
        partprobe /dev/sda || exit $?
        mount -o remount,rw / || exit $?
        btrfs filesystem resize max / || exit $?
      when: "'image_volsize' in kvm_machine"
    - name: replace ssh host keys 
      args:
        executable: /bin/bash
      shell: |
        /usr/local/bin/replace_ssh_host_keys.sh /etc/ssh || exit $?
    - name: drop root password
      linefile:
        path: /etc/shadow
        regexp: '^root:'
        line: 'root:!:17311:0:99999:7:::'
    - name: Mount up 9p filesystems if any 
      mount:
        path: '/{{ kvm_machine_filesystem.mountpoint }}'
        src: '{{ kvm_machine_filesystem.name }}'
        fstype: 9p
        opts: trans=virtio,rw
        state: mounted
      with_items: "{{ kvm_machine.filesystems|default([]) }}"
      loop_control:
        loop_var: kvm_machine_filesystem
